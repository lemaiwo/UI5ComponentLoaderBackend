"use strict";                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
sap.ui.define(["be/wl/zcomploaderlib/controllers/BaseController", "sap/ui/core/Component", "sap/ui/core/ComponentContainer", "be/wl/zcomploaderlib/library", 'sap/ui/thirdparty/hasher'], function (Controller, Component, ComponentContainer, CompLoadLib, ha+
sher) {                                                                                                                                                                                                                                                        
  "use strict";                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
  return Controller.extend("be.wl.CompLoaderApp.controller.App", {                                                                                                                                                                                             
    onInit: function onInit() {                                                                                                                                                                                                                                
      this.ConfigState = this.getOwnerComponent().getState(this.getOwnerComponent().CONFIG);                                                                                                                                                                   
      this.oOwnerComponent = this.getOwnerComponent();                                                                                                                                                                                                         
      this.oRouter = this.oOwnerComponent.getRouter();                                                                                                                                                                                                         
      this.oRouter.attachRouteMatched(this.onRouteMatched, this);                                                                                                                                                                                              
      this.refreshOnNavigation = false;                                                                                                                                                                                                                        
      this.level = 1;                                                                                                                                                                                                                                          
      this.view = "master";                                                                                                                                                                                                                                    
      this.currentRouteName = "query";                                                                                                                                                                                                                         
      this.showComponent(this.level);                                                                                                                                                                                                                          
    },                                                                                                                                                                                                                                                         
    onRouteMatched: function onRouteMatched(event) {                                                                                                                                                                                                           
      var sRouteName = event.getParameter("name"),                                                                                                                                                                                                             
          args = event.getParameter("arguments");                                                                                                                                                                                                              
      this.level = 1; //args.level || 1;                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
      this.view = "master"; //args.view || "master";                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
      if (args) {                                                                                                                                                                                                                                              
        if (args.level) {                                                                                                                                                                                                                                      
          this.level = args.level;                                                                                                                                                                                                                             
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        if (args.view) {                                                                                                                                                                                                                                       
          this.view = args.view;                                                                                                                                                                                                                               
        }                                                                                                                                                                                                                                                      
      } //to fix fuzzy search focus                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
      if (this.currentRouteName && this.currentRouteName === sRouteName && this.getComponent(this.level).isFioriElements()) {                                                                                                                                  
        return;                                                                                                                                                                                                                                                
      } // Save the current route name                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
      this.currentRouteName = sRouteName;                                                                                                                                                                                                                      
      this.showComponent(this.level);                                                                                                                                                                                                                          
    },                                                                                                                                                                                                                                                         
    getPrevMatchedRoute: function getPrevMatchedRoute() {                                                                                                                                                                                                      
      return this.getRouter()._oRouter._prevMatchedRequest; // eslint-disable-line                                                                                                                                                                             
    },                                                                                                                                                                                                                                                         
    onStateChanged: function onStateChanged(oEvent) {                                                                                                                                                                                                          
      var bIsNavigationArrow = oEvent.getParameter("isNavigationArrow"),                                                                                                                                                                                       
          sLayout = oEvent.getParameter("layout"); // Replace the URL with the new layout if a navigation arrow was used                                                                                                                                       
                                                                                                                                                                                                                                                               
      if (bIsNavigationArrow) {                                                                                                                                                                                                                                
        this.oRouter.navTo(this.currentRouteName, {                                                                                                                                                                                                            
          layout: sLayout,                                                                                                                                                                                                                                     
          // assetid: this.currentAssetId,                                                                                                                                                                                                                     
          level: this.level,                                                                                                                                                                                                                                   
          view: this.view                                                                                                                                                                                                                                      
        }, true);                                                                                                                                                                                                                                              
      }                                                                                                                                                                                                                                                        
    },                                                                                                                                                                                                                                                         
    setHashSilently: function setHashSilently(hash) {                                                                                                                                                                                                          
      hasher.changed.active = false; //disable changed signal                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
      hasher.setHash(hash); //set hash without dispatching changed signal                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
      hasher.changed.active = true; //re-enable signal                                                                                                                                                                                                         
    },                                                                                                                                                                                                                                                         
    getComponent: function getComponent(level) {                                                                                                                                                                                                               
      return this.getScenario().getComponent(level);                                                                                                                                                                                                           
    },                                                                                                                                                                                                                                                         
    getScenario: function getScenario() {                                                                                                                                                                                                                      
      return this.ConfigState.getProperty("scenario");                                                                                                                                                                                                         
    },                                                                                                                                                                                                                                                         
    showComponent: function showComponent(level) {                                                                                                                                                                                                             
      var _this = this;                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
      var currentHash = hasher.getHash(); //get current hash                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
      this.ConfigState.getConfig().then(function (config) {                                                                                                                                                                                                    
        if (_this.getComponent(level).isFioriElements()) {                                                                                                                                                                                                     
          _this.setHashSilently("");                                                                                                                                                                                                                           
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        return config;                                                                                                                                                                                                                                         
      }).then(function (config) {                                                                                                                                                                                                                              
        return _this.ConfigState.getUIComponent(_this.level);                                                                                                                                                                                                  
      }).then(function (comp) {                                                                                                                                                                                                                                
        // if (comp.firsttime || this.getComponent(level).isFioriElements()) {                                                                                                                                                                                 
        if (comp.firsttime) {                                                                                                                                                                                                                                  
          //first time only for fiori elements as well                                                                                                                                                                                                         
          if (typeof comp.component.attachAction === "function") {                                                                                                                                                                                             
            comp.component.attachAction(_this.onAction.bind(_this, _this.level));                                                                                                                                                                              
          } //only first time set title for a component                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          _this.getOwnerComponent()._oScenarioService.getTitle(_this.getScenario().scenario).then(function (response) {                                                                                                                                        
            comp.component.getManifest()["sap.app"].title = response.data.scenario_descr;                                                                                                                                                                      
          });                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        var currentContainerContent = _this.byId("flexibleColumnLayout").getAggregation(_this.getComponent(level).getViewAggregation() + "s"); //first time + different component in same aggregation => update aggregation                                    
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        if (_this.getComponent(level).isFioriElements() || !currentContainerContent || currentContainerContent.length === 0 || comp.component.getMetadata() !== currentContainerContent[0].getComponentInstance().getMetadata()) {                             
          _this.byId("flexibleColumnLayout")[_this.getComponent(level).getViewAggregationRemoveFn()]();                                                                                                                                                        
                                                                                                                                                                                                                                                               
          var compContainer = new ComponentContainer({                                                                                                                                                                                                         
            component: comp.component,                                                                                                                                                                                                                         
            height: "100%",                                                                                                                                                                                                                                    
            width: "100%"                                                                                                                                                                                                                                      
          });                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
          _this.byId("flexibleColumnLayout")[_this.getComponent(level).getViewAggregationAddFn()].call(_this.byId("flexibleColumnLayout"), compContainer, false); //update custom components second time                                                       
          //first time is done by creating the component                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          if (!comp.firsttime && !_this.getComponent(level).isFioriElements()) {                                                                                                                                                                               
            _this.getScenario().updateUIComponent(level);                                                                                                                                                                                                      
          } //update model of fiori element second time when changes are made in detail page                                                                                                                                                                   
          //first time is done automatically                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          if (!comp.firsttime && _this.refreshOnNavigation && _this.getComponent(level).isFioriElements()) {                                                                                                                                                   
            _this.refreshOnNavigation = false;                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            _this.getComponent(level).UIComponent.getModel().refresh();                                                                                                                                                                                        
          }                                                                                                                                                                                                                                                    
        } else {                                                                                                                                                                                                                                               
          //trigger update action in component only                                                                                                                                                                                                            
          _this.getScenario().updateUIComponent(level);                                                                                                                                                                                                        
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        if (_this.getComponent(level).isFioriElements() && comp.component) {                                                                                                                                                                                   
          //works first time, when closing detail it reloads (should not be needed if no input is received) and shows no target found                                                                                                                          
          var uiVersion;                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
          try {                                                                                                                                                                                                                                                
            uiVersion = parseInt(sap.ui.version.split(".")[1], 10);                                                                                                                                                                                            
          } catch (error) {                                                                                                                                                                                                                                    
            uiVersion = 0;                                                                                                                                                                                                                                     
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          if (uiVersion < 70) {                                                                                                                                                                                                                                
            comp.component.getRouter().mEventRegistry.routeMatched && comp.component.getRouter().mEventRegistry.routeMatched.forEach(function (route) {                                                                                                        
              comp.component.getRouter().detachRouteMatched(route.fFunction, route.oListener);                                                                                                                                                                 
            });                                                                                                                                                                                                                                                
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          comp.component.getRouter().mEventRegistry.bypassed && comp.component.getRouter().mEventRegistry.bypassed.forEach(function (route) {                                                                                                                  
            comp.component.getRouter().detachBypassed(route.fFunction, route.oListener);                                                                                                                                                                       
          }); // for (var route in comp.component.getRouter()._oRoutes) {                                                                                                                                                                                      
          // 	if (route.indexOf("root") === -1)                                                                                                                                                                                                                
          // }                                                                                                                                                                                                                                                 
          // comp.component.getRouter()._oRoutes = {                                                                                                                                                                                                           
          // 	root: comp.component.getRouter()._oRoutes.root,                                                                                                                                                                                                  
          // 	rootquery: comp.component.getRouter()._oRoutes.rootquery                                                                                                                                                                                         
          // };                                                                                                                                                                                                                                                
        } // } else {                                                                                                                                                                                                                                          
        // 	this.getScenario().updateUIComponent(level);                                                                                                                                                                                                       
        // }                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        if (_this.getComponent(level).isFioriElements()) {                                                                                                                                                                                                     
          _this.setHashSilently(currentHash);                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
      }); // .then((error) => {                                                                                                                                                                                                                                
      // 	console.log(error);                                                                                                                                                                                                                                  
      // });                                                                                                                                                                                                                                                   
    },                                                                                                                                                                                                                                                         
    onAction: function onAction(level, event) {                                                                                                                                                                                                                
      // var item = event.getParameter("item");                                                                                                                                                                                                                
      //keep selection in state for next component                                                                                                                                                                                                             
      this.refreshOnNavigation = false;                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
      if (event.getParameter("type") === CompLoadLib.CentralEntryPointType.ForceRefresh) {                                                                                                                                                                     
        this.refreshOnNavigation = true;                                                                                                                                                                                                                       
        return;                                                                                                                                                                                                                                                
      }                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
      this.getComponent(level).setData(event.getParameter("data"));                                                                                                                                                                                            
      var component;                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
      if (event.getParameter("type") === CompLoadLib.CentralEntryPointType.Back) {                                                                                                                                                                             
        component = this.getScenario().getPreviousComponent(level);                                                                                                                                                                                            
      }                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
      if (event.getParameter("type") === CompLoadLib.CentralEntryPointType.Navigate) {                                                                                                                                                                         
        component = this.getScenario().getNextComponent(level);                                                                                                                                                                                                
      }                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
      if (event.getParameter("type") === CompLoadLib.CentralEntryPointType.NavigateToLevel) {                                                                                                                                                                  
        component = this.getScenario().getComponent(event.getParameter("level"));                                                                                                                                                                              
      }                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
      if (component) {                                                                                                                                                                                                                                         
        //get next component info                                                                                                                                                                                                                              
        // let nextComponent = this.getScenario().getNextComponent(level);                                                                                                                                                                                     
        if (component.getLevel() !== this.level) {                                                                                                                                                                                                             
          this.oRouter.navTo("app", {                                                                                                                                                                                                                          
            view: component.getView(),                                                                                                                                                                                                                         
            layout: component.getLayout(),                                                                                                                                                                                                                     
            level: component.getLevel()                                                                                                                                                                                                                        
          });                                                                                                                                                                                                                                                  
        } else if (event.getParameter("type") === CompLoadLib.CentralEntryPointType.Navigate || event.getParameter("type") === CompLoadLib.CentralEntryPointType.NavigateToLevel) {                                                                            
          if (component.isFioriElements()) {                                                                                                                                                                                                                   
            this.showComponent(component.getLevel());                                                                                                                                                                                                          
          } else {                                                                                                                                                                                                                                             
            this.getScenario().updateUIComponent(component.getLevel());                                                                                                                                                                                        
          } // if (this.getComponent(this.getScenario().getNextLevel(level)).isFioriElements()) {                                                                                                                                                              
          // 	this.showComponent(this.getScenario().getNextLevel(level));                                                                                                                                                                                      
          // } else {                                                                                                                                                                                                                                          
          // 	this.getScenario().updateNextUIComponent(level);                                                                                                                                                                                                 
          // }                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
        }                                                                                                                                                                                                                                                      
      }                                                                                                                                                                                                                                                        
    },                                                                                                                                                                                                                                                         
    onExit: function onExit() {                                                                                                                                                                                                                                
      this.oRouter.detachRouteMatched(this.onRouteMatched, this);                                                                                                                                                                                              
    }                                                                                                                                                                                                                                                          
  });                                                                                                                                                                                                                                                          
});                                                                                                                                                                                                                                                            